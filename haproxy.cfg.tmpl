# Generated by confd {datetime.Format("Jan 2, 2006 at 3:04pm (MST)")}

global
  daemon
  maxconn 4096
  pidfile /var/run/haproxy.pid

defaults
  mode tcp
  timeout connect 5s
  timeout client 1m
  timeout server 1m
  option redispatch
  balance roundrobin

listen stats :1936
  mode http
  stats enable
  stats hide-version
  #stats realm Haproxy\ Statistics
  stats uri /
  #stats auth Username:Password

frontend http
  bind *:80
  {{range $host := lsdir "/haproxy/hosts"}}
  acl host_{{base $host}} hdr(host) -i {{base $host}}
  {{end}}

  {{range $host := lsdir "/haproxy/hosts"}}
    {{$locations := printf "/haproxy/hosts/%s/locations" $host}}
    {{range $location := lsdir $locations}}
      {{$path := printf "/haproxy/hosts/%s/locations/%s/path" $host $location}}
      {{with get $path}}
  acl host_{{base $host}}_location_{{base $location}} path_beg -i {{.Value}}
      {{end}}
      {{$backend := printf "/haproxy/hosts/%s/locations/%s/backend" $host $location}}
      {{with get $backend}}
  use_backend {{.Value}} if host_{{base $host}} host_{{base $host}}_location_{{base $location}}
      {{end}}
    {{end}}
  {{end}}

{{range $backend := lsdir "/haproxy/backends"}}
backend {{base $backend}}
  balance roundrobin
  {{$server := printf "/haproxy/backends/%s/servers/*" $backend}}{{range gets $server}}
  server {{base .Key}} {{.Value}}
  {{end}}
{{end}}
